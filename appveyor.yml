image: Visual Studio 2015

platform: x86_64

environment:
  global:
    TARGET: snowchains.exe
    RUSTUP_TOOLCHAIN: stable
    RUSTUP_HOST: x86_64-pc-windows-msvc
    RUST_BACKTRACE: full
    ATCODER_USERNAME:
      secure: koc3zc/wQPQvMQj1hJCjKQ==
    ATCODER_PASSWORD:
      secure: zndOc4jqvw5aigjpDnoUSEycIHdwddCYtI8gh/o2yBvDnL3GIT0ea0YavFmdMDMA
    HACKERRANK_USERNAME:
      secure: H8+ut9G/t8aUFXYcBHGA/VRYHBZ0jDA/vnNYTUlbZ+Q=
    HACKERRANK_PASSWORD:
      secure: YCYQSV4TkGO8oHAkURbWzb6P57lzjE7NxUxy/c1XA2E=
    YUKICODER_REVEL_SESSION:
      secure: rP8YsAvXYCoynuZozzvOucSzyybl7HggzAuKhlFQCocBkskrxJfBQPdQWQZVFgZ8F5GC/Z8QqKRW/dBsUC0p3hUtvdpvdlN7uhChxBMA4UhwmjZoy8xa8oR1RoWPCvOk2c0hv6QJIJ4wzjGkXQTHpHR6E3B4fJgzrfr6ErfkqMiITsw96J9p3ZyutJzVo6rGDof1AHfDYx/XRbhgxNlks0aL2a9yRwaO1TZZOjduKvHVnCOc7QV1k1/yMBwH65fhBcovC+1KDJLq7AZ0kVZMSg==

install:
  - ps: Start-FileDownload "https://static.rust-lang.org/rustup/dist/${env:RUSTUP_HOST}/rustup-init.exe"
  - rustup-init.exe -y --default-toolchain %RUSTUP_TOOLCHAIN% --default-host %RUSTUP_HOST% --no-modify-path
  - set PATH=C:\Users\appveyor\.cargo\bin;%PATH%
  - rustc -vV
  - cargo -vV

build: false

test_script:
  - set PATH=C:\msys64\usr\bin;%PATH%
  - sh -c "[ -z \"${ATCODER_USERNAME}\" ] && TEST_TARGETS=lib || TEST_TARGETS=all; cargo test --$TEST_TARGETS"

before_deploy:
  - cargo build --release
  - ps: Move-Item "target\release\${env:TARGET}" .\
  - cd C:\projects
  - ps: |
      $ZIP = "${env:APPVEYOR_BUILD_FOLDER}/${env:APPVEYOR_PROJECT_NAME}-${env:APPVEYOR_REPO_TAG_NAME}-${env:RUSTUP_HOST}.zip"
      7z a "$ZIP" "${env:APPVEYOR_PROJECT_NAME}/${env:TARGET}" "${env:APPVEYOR_PROJECT_NAME}/LICENSE" "${env:APPVEYOR_PROJECT_NAME}/README.md"
      7z l "$ZIP"
      Push-AppveyorArtifact "$ZIP"
  - cd %APPVEYOR_BUILD_FOLDER%

deploy:
  - provider: GitHub
    artifact: /^.*\.zip$/
    auth_token:
      secure: khL++opdJh5x79PMMTkOJXPXi8D+ijp0os5Bi02rA4DSApOmuF1VuZWpIzyDZ8pi
    on:
      appveyor_repo_tag: true

cache:
  - '%HOME%\.cargo\git'
  - '%HOME%\.cargo\registry\index'
  - '%HOME%\.cargo\registry\src'

notifications:
  - provider: Email
    on_build_success: true
    on_build_failure: true

branches:
  only:
    - master
    - /^v\d+\.\d+\.\d+.*$/
